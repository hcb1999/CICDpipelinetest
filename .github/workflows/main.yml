name: CI/CD Pipeline

on:
  push:
    branches:
      - master  # master ë¸Œëžœì¹˜ í‘¸ì‹œ ì‹œ í”„ë¡œë•ì…˜ ë°°í¬
      - develop # develop ë¸Œëžœì¹˜ í‘¸ì‹œ ì‹œ ìŠ¤í…Œì´ì§• ë°°í¬

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v2

      # 2. Node.js í™˜ê²½ ì„¤ì •
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: npm install

      # 4. ë¹Œë“œ ì‹¤í–‰
      - name: Build project
        run: npm run build

      # 5. ì„œë²„ í˜¸ìŠ¤íŠ¸ í‚¤ ì¶”ê°€ (í˜¸ìŠ¤íŠ¸ í‚¤ ê²€ì¦ ì˜¤ë¥˜ ë°©ì§€)
      - name: Add SSH host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H www-test.naegift.com >> ~/.ssh/known_hosts
          ssh-keyscan -H www-dev.naegift.com >> ~/.ssh/known_hosts

      # 6. í”„ë¡œë•ì…˜ ì„œë²„ ë°°í¬ (master ë¸Œëžœì¹˜)
      - name: Deploy to production
        if: github.ref == 'refs/heads/master'
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY_AZURE_GIVU_TEST }}" > naegift-test_key.pem
          chmod 600 naegift-test_key.pem
          scp -o StrictHostKeyChecking=no -r -i naegift-test_key.pem ./build/* naegift@www-test.naegift.com:/var/www/html
          ssh -o StrictHostKeyChecking=no -i naegift-test_key.pem naegift@www-test.naegift.com "sudo systemctl restart nginx"

      # 7. ìŠ¤í…Œì´ì§• ì„œë²„ ë°°í¬ (develop ë¸Œëžœì¹˜)
      - name: Deploy to staging
        if: github.ref == 'refs/heads/develop'
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY_AZURE_GIVU_DEV }}" > naegift-dev2_key.pem
          chmod 600 naegift-dev2_key.pem
          scp -o StrictHostKeyChecking=no -r -i naegift-dev2_key.pem ./build/* naegift@www-dev.naegift.com:/var/www/html
          ssh -o StrictHostKeyChecking=no -i naegift-dev2_key.pem naegift@www-dev.naegift.com "sudo systemctl restart nginx"

      # 8. ðŸ”¹ ìžë™ íƒœê¹… (master ë¸Œëžœì¹˜ì—ì„œ ì‹¤í–‰)
      - name: Auto Increment Version and Tag for Production
        if: github.ref == 'refs/heads/master'
        run: |
          # ì‚¬ìš©ìž ì´ë¦„ê³¼ ì´ë©”ì¼ ì„¤ì •
          git config --global user.email "hcb1999@naver.com"
          git config --global user.name "hcb1999"

          # GitHub ì¸ì¦ ì„¤ì •
          git config --global credential.helper 'store'
          echo "https://github-actions:${{ secrets.GH_TOKEN }}@github.com" > ~/.git-credentials

          git fetch --tags
          LATEST_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1)

          if [[ "$LATEST_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            MAJOR=$(echo $LATEST_TAG | cut -d. -f1 | sed 's/v//')
            MINOR=$(echo $LATEST_TAG | cut -d. -f2)
            PATCH=$(echo $LATEST_TAG | cut -d. -f3)
            NEW_TAG="v$MAJOR.$MINOR.$((PATCH + 1))"
          else
            NEW_TAG="v1.0.0"
          fi

          echo "New Production Tag: $NEW_TAG"
          git tag -a "$NEW_TAG" -m "Release $NEW_TAG"
          git push origin "$NEW_TAG"
