name: CI/CD Pipeline

on:
  push:
    branches:
      - master  # master Î∏åÎûúÏπò Ìë∏Ïãú Ïãú ÌîÑÎ°úÎçïÏÖò Î∞∞Ìè¨
      - develop # develop Î∏åÎûúÏπò Ìë∏Ïãú Ïãú Ïä§ÌÖåÏù¥Ïßï Î∞∞Ìè¨

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Î¶¨Ìè¨ÏßÄÌÜ†Î¶¨ ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout code
        uses: actions/checkout@v2

      # 2. Node.js ÌôòÍ≤Ω ÏÑ§Ï†ï
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'

      # 3. ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
      - name: Install dependencies
        run: npm install

      # 4. ÎπåÎìú Ïã§Ìñâ
      - name: Build project
        run: npm run build

      # 5. ÌîÑÎ°úÎçïÏÖò ÏÑúÎ≤Ñ Î∞∞Ìè¨ (master Î∏åÎûúÏπò)
      - name: Deploy to production
        if: github.ref == 'refs/heads/master'
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY_AZURE_GIVU_TEST }}" > naegift-test_key.pem
          chmod 600 naegift-test_key.pem
          scp -o StrictHostKeyChecking=no -r -i naegift-test_key.pem ./build/* naegift@www-test.naegift.com:/var/www/html
          ssh -o StrictHostKeyChecking=no -i naegift-test_key.pem naegift@www-test.naegift.com "sudo systemctl restart nginx"

      # 6. Ïä§ÌÖåÏù¥Ïßï ÏÑúÎ≤Ñ Î∞∞Ìè¨ (develop Î∏åÎûúÏπò)
      - name: Deploy to staging
        if: github.ref == 'refs/heads/develop'
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY_AZURE_GIVU_DEV }}" > naegift-dev2_key.pem
          chmod 600 naegift-dev2_key.pem
          scp -o StrictHostKeyChecking=no -r -i naegift-dev2_key.pem ./build/* naegift@www-dev.naegift.com:/var/www/html
          ssh -o StrictHostKeyChecking=no -i naegift-dev2_key.pem naegift@www-dev.naegift.com "sudo systemctl restart nginx"

      # 7. üîπ **ÏûêÎèô ÌÉúÍπÖ (master Î∏åÎûúÏπò)**
      - name: Auto Increment Version and Tag for Production
        if: github.ref == 'refs/heads/master'
        run: |
          git fetch --tags
          LATEST_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1)

          if [[ "$LATEST_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            MAJOR=$(echo $LATEST_TAG | cut -d. -f1 | sed 's/v//')
            MINOR=$(echo $LATEST_TAG | cut -d. -f2)
            PATCH=$(echo $LATEST_TAG | cut -d. -f3)
            NEW_TAG="v$MAJOR.$MINOR.$((PATCH + 1))"
          else
            NEW_TAG="v1.0.0"
          fi

          echo "New Production Tag: $NEW_TAG"
          git tag -a "$NEW_TAG" -m "Release $NEW_TAG"
          git push origin "$NEW_TAG"
